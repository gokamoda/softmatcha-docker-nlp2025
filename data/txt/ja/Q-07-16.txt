LLM 埋め込みと遷移確率予測を利用した実店舗内顧客行動シミュレーション

宮本遼人

1,2

春日瑛

21

早稲田大学 基幹理工学部 

2

株式会社サイバーエージェント



r-miyamoto@toki.waseda.jp  kasuga akira@cyberagent.co.jp



概要

実店舗での顧客行動シミュレーションは物理的な制約やコストから難しく、WEB のような A/B テストが不可能なため需要が高い。
本研究では顧客の店内行動をシミュレートするフレームワーク LISSを提案する。
店内をエリア区分し、隣接する棚や商品、滞在時間を LLM で埋め込み化することで、新商品の追加やレイアウト変更が購入率や滞在時間に与える影響を推定する。
手法は過去の店舗行動ログを用いて学習し、変更時の行動変化を推論する。
EZOHUB TOKYO における実データを用いて商品追加や配置変更の影響、情報拡張による推論安定化、柔軟な条件の設定が可能であることを確認した。
実運用向けの推論アプリケーションも開発した。


1 はじめに

小売店舗における棚割やレイアウトの最適化は、売上の最大化に加えて顧客体験の向上にも不可欠な課題である。
しかし、従来の最適化手法は、熟練担当者の経験や実店舗での試行錯誤に大きく依存しておりコストや時間の面で非効率的であるだけでなく、新規商品の追加や売り場カテゴリの変更が生じた際の効果を事前に数値的に予測することが難しいという問題がある。
その結果、顧客行動の詳細な把握やデータに基づく戦略的意思決定の実現が十分になされていないケースが多いと考えられる。
本研究では、店舗レイアウトの最適化問題に対して課題を解決するため、新たなフレームワーク LISS(Language-based In-Store Simulator)を提案する。
これは、Web マーケティング分野の顧客行動シミュレーション技術を基盤とする CXSimulator[1]を実店舗に適用したものである。
具体的には、事前に収集した顧客の店内移動ログを基に、位置や滞在時間、商品情報などをノードとする遷移グラフを構築し、LLM による商品情報の埋め込み化を通じて、ノード間の意味的関連性を考慮する。
これにより、新規商品カテゴリの追加やノード位置の変更などが行われた場合でも、言語情報を基盤とした遷移確率推定を用いて、既存の動線や顧客行動への影響を定量的に評価することが可能となる。
さらに、本フレームワークは推論時に大量の計算資源を要しないため、低コストかつ短時間で多様な検証を実行できるという特長を有する。
これにより、コストやリスクを削減しつつ複数の配置案を比較検討することが可能となる。
本研究の成果は、小売業界が直面する課題に対する新たな解決策を提示し、将来的な店舗モデルの革新に貢献できる。


2 関連研究



2.1 機械学習による顧客行動の予測

深層学習や生成モデル、機械学習手法などを活用した顧客行動の予測手法が数多く提案されており[2, 3]、実店舗における顧客行動予測においても同様である。
生成的予測として、Transformer[4]ベースの深層学習モデルを用いて顧客の行動経路と購買行動を生成する手法[5]や、LSTM などの時系列モデルを用いた手法[6, 7]、特徴量作成と決定木による予測[8, 9]などが研究されている。
既存研究は、顧客行動のモデリングと予測に多様なアプローチを示し、実店舗空間における高度なシミュレーション手法を確立するための基盤となっている。
また、機械学習を用いない分析的手法も仮説検証において重要である。
[10, 11, 12]

2.2 顧客行動シミュレーション

本研究の前身となる CXSimulator[1]は、ユーザーの行動履歴を、LLM による埋め込みとして表現する点が特徴である。
また、その埋め込みを用いてイベント間の遷移確率を予測するモデルを学習し、これによって多様な学習データから、初見のイベントに対するユーザー行動も予測可能となる。
予測された遷移予測モデルを活用することで、実際のオンライン A/B テストを行わずとも、新たなキャンペーンや商品に対してユーザーがどのように反応するかをシミュレートでき、より迅速かつ効果的にキャンペーンを実施することが可能となる。
本研究では、実店舗の制約に対応し、より柔軟な検証を可能にしたフレームワークを提案する。


3 手法

本研究では、実店舗における顧客行動をオフラインでシミュレートするためのフレームワーク LISSを提案する。
このフレームワークは、Webマーケティングにおける顧客行動予測のため開発されたCXsimulator を基盤とし、実店舗特有の制約条件に対応を加え発展させたものである。
本フレームワークでは、顧客の行動を自然言語形式で記述することで、店内のエリアや時間、陳列商品などの情報を状態として保持し、それら状態間の遷移確率を決定木ベースのモデルを用いて推定する。
全体のフレームワークは、1. 遷移グラフの構築2. LLM 埋め込みによる遷移確率予測モデルの構築3. 遷移グラフの確率予測による再構成とシミュレーションの 3 つのステップで構成される。
2 ステップ目では，LLM の埋め込みを 2 つの決定木モデルに学習させ、その結合可否と遷移確率を推定しモデルを構築する。


3.1 CXSimulator の実店舗における課題

既存の CXSimulator は、実店舗での実証に置いて以下のような課題を持つ。
遷移制限 Web サイトであれば自由にページ遷移できるようリンクが可能だが実店舗では商品陳列やレイアウトなどの物理的な制約によって動線が固定されやすく自由な遷移を設定できない。
ノード操作機能の不足 CXSimulator はノードの追加のみが可能であり、実店舗運用で頻繁に行われる商品や陳列の削除・交換などには対応していない。
これらの課題に対応するためには、実店舗の特性を考慮した新たな機能や拡張が必要とされる。



3.2 遷移可能なノード制約の追加

実店舗でのシミュレーションでは、変更を加えるノードが結合可能なノードに位置的な制約を受ける。
これに対応するため、店舗の図面を基に遷移可能なノード郡を作成し、システム的に結合を管理する実装を行なった。
遷移グラフの構築時や分類・回帰モデルの実行時に現実に即した結果が得られることはもちろん、遷移グラフ再構成時にも、制約を考慮したノードの操作が可能となる。

3.3 ノードの削除・交換の実装

実店舗での商品や陳列を入れ替える際には、既存ノード（商品）を削除あるいは交換し、新たなノードを追加して再度遷移確率を付与する必要がある。
ここで、有向グラフ 𝐺 = (𝑉, 𝐸)を遷移グラフと呼び、 𝑉 はそれぞれが個々のイベントに対応するノードを表す。
𝐸 はイベント間の遷移を表すエッジの集合を示す。
各エッジ(𝑣𝑖, 𝑣𝑗) ∈ 𝐸 は遷移確率 𝑤(𝑣𝑖, 𝑣𝑗) ∈ (0, 1]を持ち、これはノード𝑣𝑖, 𝑣𝑗∈ 𝑉 に対して定義される。
状態数 𝑚 を用いて{𝑖, 𝑗 | 1, 2, . . . , m} とする。
3.3.1 ノード削除ノード削除は、単純に指定ノード 𝒗delとその周辺エッジを取り除くだけではなく、削除に伴い出力エッジ総和が変動した、すなわち𝒗delへのエッジを持っていた任意の 𝑣predについて確率再分配を行う必要がある。
𝑤′(𝑣pred, 𝑣) =𝑤(𝑣pred, 𝑣)∑𝑣′∈𝑆𝑤(𝑣pred, 𝑣′),ここで 𝑆 はノード削除後に、𝑣predから到達可能な後ノードの集合、𝑤(𝑣pred, 𝑣)はノード 𝑣predから 𝑣 へ至るエッジの重み（遷移確率）である。
上式のとおり、エッジ削除後に総和が変わるため、再度正規化することで確率グラフとしての整合性を保つ。
3.3.2 ノード交換ノード交換では、あるノード 𝒗oldとその入出力エッジを削除し、新ノード 𝒗newを追加したうえで、削除前のノードに入出力していた遷移確率を再配分して接続を復元する。
具体的には以下の 4 ステップで実装される。
この操作では 𝑢, 𝑣 ∈ 𝑉 からなる𝑢 → 𝑣 の遷移について、回帰モデルによって推定されるノード間遷移確率 𝑝 (𝑢, 𝑣)を利用する。
1. 古いノードの削除: 𝒗oldとそれに関連する任意のエッジ { (𝒖, 𝒗old), (𝒗old, 𝒘)} をグラフ 𝐺 から削除する。
2. 新ノードの追加: 𝒗newをグラフに追加する。
3. エッジの追加と遷移確率の設定: モデルによって回帰された遷移確率を考慮して、新ノードへのエッジに重みを割り当てる。
𝒗newに遷移するノード 𝒗𝑠を考える時、そのエッジ重みを𝑝(𝒗𝑠, 𝒗new) × 𝛾 として接続する。
ここで 𝛾 は必要に応じて重みを増減させるハイパーパラメータである。
4. 関連ノードの正規化: 削除時と同様の正規化を操作に関連する全てのノードに施し、確率遷移モデルとしての整合性を担保する。


4 実験

本研究では、検証に EZOHUB TOKYO1）のデータを利用した。
実店舗で CXSimulator を応用するため、データに含まれるノイズや付加情報、遷移可能なエリアを考慮した適切な前処理を施し、新規機能の確認、ユーザー検証用の実装、シミュレーションによる効果検証を行った。
利用したデータとして、対象期間内に購入された商品の情報、購入者、購入日時を含む POS データと店内を複数のエリアに分割し、各エリアでの顧客の滞在時間を取得した AWL2）による店内顧客のトラッキングデータが挙げられる。
また、実験のための埋め込み生成にはOpenAI の text-embedding-3-small[13]を、遷移確率予測には XGboost[14]を利用した。



4.1 データクリーニング

実験では、EZOHUB TOKYO で 2024 年 6 月〜9 月に収集された POS および店内移動のトラッキングデータを使用した。
実データにはノイズが含まれるため、理想的なシミュレーション実現のため遷移データを前処理し、予測に用いるノード情報を豊富にするため POS データも解析した。
遷移データの前処理では、非隣接ノード間の不自然な遷移を削除して整合性を高め、トラッキングとPOS データをマッチングして顧客の購入行動を特1） https://ezohub.jp/oﬃce/tokyo/2） https://awl.co.jp/定・購入状態を生成した。
さらに、滞在時間を 0〜5 秒、5〜15 秒、15〜30 秒、30 秒以上の 4 区間に分け、それぞれの遷移確率を算出した。
また、POS データの解析を通じてノードの情報を強化した。
具体的には、POS データに記録された商品のアクセス可能エリアを特定するためにGPT-4o-mini[15]を活用し、各商品がどのエリアからアクセス可能かをラベリングした。
このラベリング作業には、各エリアに人手で付記された隣接棚のカテゴリ情報と、POS データ内の商品名を利用した。
こうした処理を通じて、各ノードに関連する商品カテゴリ情報を補強し、埋め込みの利用による精度の高いシミュレーションを可能にした。



4.2 モデルの構築

手法より、結合可否の分類と遷移確率の回帰の 2タスクのため、それぞれモデルを学習する。
モデルの評価値について、分類モデルは f1 スコアが 0.987，AUC が 0.881 であった。
また、回帰モデルは RMSEが 0.096，SMAPE[16]は 44.79%であった。


4.3 ユーザー検証用の実装

本節では、LISS の社会実装に向けて、モデルに簡便にアクセスできる Web アプリケーションを開発した（図 1 参照）。
この UI では、ノードの追加や入れ替えが可能であり、直感的に対象エリアを選択できる仕組みを備えている。
また、シミュレーションの結果として、購入人数や滞在時間、購入者の店内滞在時間のヒートマップを確認することができる。
これにより、専門的な知識がなくても、現場の担当者が自身のアイデアをシミュレーションし、有効な施策を選定・実行することが可能になる。

4.4 シミュレーションの実行

本節では、実店舗における新規カテゴリの追加および配置の交換のシミュレーションを実行する。
各シミュレーションは、二週間辺りの店舗平均来訪数をもとに 10,000 件のセッションをシミュレーションし、購入人数と平均滞在時間を測定した結果を記録している。
ここで、店舗に変更を加えない場合の購入回数は 192 回、滞在時間の平均は 82.59 秒と予測された。
また、実験環境となった実店舗の見取り図は図 2 に示す。
なおこの店舗はオフィス内の売店である。
図 1 (左)入れ替え結果(右)追加結果表 1 追加の結果追加カテゴリ対象購入回数変化滞在時間変化オフィス用品 12 左 +7.29% +1.90%栄養食品 12 左 +10.42% +1.45%健康家電 18 左 +0.52% +0.70%アウトドア用品 12 左 -3.65% +3.11%アクセサリー 12 左 -11.98% +3.26%生魚 6 上 -17.71% +9.20%4.4.1 新規カテゴリの追加新規カテゴリ追加では、表 1 中に示す 6 つのカテゴリについて追加を検証した。
表 1 の結果から、店舗の特徴も踏まえた推論がされ、オフィス内で簡単に利用できる小物が売上の向上に対して寄与する割合が高いことがわかる。
実際に EZOHUB はオフィス街に位置しており、妥当性の高い結果である。
4.4.2 配置の交換配置では、実際に変更が可能な箇所の配置を全てシミュレーションした。
ビジネス的に有効かつ不可能でない箇所を交換検証の対象としていて、例えば大型の棚や冷蔵庫を伴う商品に隣接するエリアなどは対象から除外している。
結果(表 2)では、対象となる店舗図中の各 id がそれぞれ交換された際の指標の変化を表現している。
店舗の構造上入り口とレジが近いため、多くの人に広く買われやすい商品を入り口付近に持ってくることが強い戦略なのは明らかだが、シミュレーションによってお菓子や文具、グミなどが広く変われる商品に該当し、ビューティー用品などは店奥に置いた方が良いという結果が得られた。
これは立地や対象表 2 配置交換の結果対象 1 対象 2 購入回数変化滞在時間変化14 22 +15.1% +1.88%20 23 +5.7% +0.84%6 9 +7.8% +0.15%12 23 -8.3% +1.37%3 19 -8.4% -0.11%6 14 -2.1% +0.81%図 2 検証店舗の店内図1: 出入り口、 2: 電子レンジ、 3: トラベル用品、 4: 通路、 5: 通路、 6: 化粧品雑貨、 7: 日用消耗品、 8: 通路、 9: グミ、 10: 通路、11:セルフレジ, 12:ビューティー/シーズン品, 13,14:医薬雑貨・マスク、 15,16: 健康食品・スナック、 17: 健康食品・均一菓子、 18: ガム/飴、 19: ポケチョコ、 20: ビスチョコ、 21:味噌汁・スープ・カップ麺、 22: 文具・電器、 23: 雨具・傘、24: 通路、 25,26: 飲料顧客を選ばない方が良いという仮説からも合理的な結果である。


5 おわりに

本研究で提案した LISS は、商品カテゴリの追加や店内レイアウトの変更による顧客行動への影響をシミュレーションすることができる。
これは、LLM埋め込みに基づく特徴表現により文章ベースの説明や滞在時間情報から、隣接エリアへの遷移が推定可能となるためである。
EZOHUB TOKYO で収集したデータを用いた実験では、未検証の施策に対しても現実的な変化予測が得られ、滞在時間や購入回数の推定タスクにおいて、売場入れ替えや新規商品の設置などを通じて提案手法の有用性が示唆された。
一方、シミュレーションの精度は、利用可能なデータ量や状態表現に含まれる情報量に左右されることがわかった。
ノードに小売店のステータスなどのより大域的な情報を付与することで、精度の向上が期待できる。
また、本研究では、実運用を想定したアプリケーションも実装しており、その成果を現実世界に適用して可用性を検証することが可能である。
さらに、OMO（Online Merges with Oﬄine）モデルとして統合的に施策を検証できるプラットフォームへの拡張も今後の展望として挙げられる。



参考文献


[1] Akira Kasuga and Ryo Yonetani. Cxsimulator: Auser behavior simulation using llm embeddings for web-marketing campaign assessment. Proceedings of the 33rdACM International Conference on Information and Knowl-edge Management (CIKM 24), 2024.
[2] 浅野輝, 米谷竜, 関井大気, 大内啓樹. Text2traj2text: 大規模言語モデルを活用した段階的データ生成に基づく人物移動軌跡の言語化. 言語処理学会 第 30 回年次大会, 2024.
[3] 浅野孝平, 稲田和明, 張信鵬. E コマースにおけるユーザー行動ログと大規模言語モデルを活用したクエリ拡張のための辞書作成. 言語処理学会 第 30 回年次大会, 2024.
[4] A Vaswani. Attention is all you need. Advances in Neu-ral Information Processing Systems, 2017.
[5] Taizo Horikomi and Takayuki Mizuno. Generating in-store customer journeys from scratch with gpt architec-tures. The European Physical Journal B, Vol. 97,No. 9, p. 144, 2024.
[6] Weizheng Zhao, Yi Zuo, Licheng Zhao, and Junhao Jiang.Application of lstm models to predict in-store trajectory ofcustomers. 2021 International Conference on DataMining Workshops (ICDMW), 12 2021.
[7] Anooshmita Das, Emil Stubbe Kolvig-Raun, andMikkel Baun Kjærgaard. Accurate trajectory predictionin a smart building using recurrent neural networks. InAdjunct Proceedings of the 2020 ACM Interna-tional Joint Conference on Pervasive and Ubiqui-tous Computing and Proceedings of the 2020 ACMInternational Symposium on Wearable Computers,UbiComp/ISWC ’20 Adjunct, p. 619–628, New York, NY,USA, 2020. Association for Computing Machinery.
[8] 中野領也, 葉山晋乃介, 村田裕人, 辻川凜, 星野崇宏.位置情報データを用いた来店行動の行動経済学的予測. 人工知能学会全国大会論文集 第 38 回 (2024),pp. 1L3GS1001–1L3GS1001. 一般社団法人 人工知能学会, 2024.
[9] 小柴等, 石垣司, 竹中毅, 本村陽一. 行動履歴データからのライフスタイル推定技術：顧客 id 付き posデータとアンケート調査による小売サービスでの実証. 人工知能学会第二種研究会資料, Vol. 2012, No.SAI-015, p. 07, 2012.
[10] Tijmen Elbers. The eﬀects of in-store layout-and shelfdesigns on consumer behavior. Wageningen UR, pp.1–22, 2016.
[11] Hyunwoo Hwangbo, Jonghyuk Kim, Zoonky Lee, andSoyean Kim. Store layout optimization using indoor posi-tioning system. International Journal of DistributedSensor Networks, Vol. 13, No. 2, p. 1550147717692585,2017.
[12] Adam Finn and Jordan J Louviere. Shopping center im-age, consideration, and choice: anchor store contribution.Journal of business research, Vol. 35, No. 3, pp. 241–251, 1996.
[13] OpenAI. New embedding models and api up-dates, 2024. https://openai.com/index/new-embedding-models-and-api-updates/.
[14] Tianqi Chen and Carlos Guestrin. Xgboost: A scalabletree boosting system. In Proceedings of the 22nd acmsigkdd international conference on knowledge dis-covery and data mining, pp. 785–794, 2016.
[15] OpenAI. Gpt-4o mini: advancing cost-eﬃcient in-telligence, 2024. https://openai.com/index/gpt-4o-mini-advancing-cost-efficient-intelligence/.
[16] Vladik Kreinovich, Hung T. Nguyen, and Rujira Oun-charoen. How to estimate forecasting quality: A system-motivated derivation of symmetric mean absolute percent-age error (smape) and other similar characteristics. 2014.




A プロンプト例

本節では、埋め込み化するためのプロンプトの例を示す。
ここで、実際の商品名は伏せ商品の情報を示す文言に変更している。
プロンプト 1 : 飲料 0〜5 秒滞在の状態ここは飲料 500ml・コーヒーのブースです。
また、ユーザーは 0〜5 秒滞在しています。
ブースでは、ペットボトルコーヒー(a) ５００ｍｌ、缶コーヒー蓋付き ３９０ｍｌ、紙パック調整豆乳 ２００ｍｌ、インスタントコーヒー瓶入り ８０ｇ、スティックコーヒー ２０Ｐ、ペットボトルコーヒー(b) ５００ｍｌ、ペットボトル コーヒー(c)３７０ｇ、紙パック抹茶豆乳２００ｍｌ、ペットボトル胡麻麦茶 ３５０ｍｌなどが販売されています。
プロンプト 2 : 文具・電器 5〜15 秒滞在の状態ここは文具・電器のブースです。
また、ユーザーは 5〜15 秒滞在しています。
ブースでは、USB Ｔｙｐｅ−Ｃケーブル１ｍＷ、静電気掃除モップ手元用本体 １組、消せるボールペン０．５黒、USB Type-C to Lightning ケーブル ２ｍ、ＵＳＢコンセントチャージャー白、リングゴム４Ｐ Ｍサイズ、袋入りフォーク １０Ｐ、ハンドタオルダイヤグレー、紙ノート A4、ライトニングケーブル０．５ｍなどが販売されています。



B 追加カテゴリ例

本節では、実験で用いた追加カテゴリの情報例を示す。
固有名詞を省き、実際に利用した商品名は伏せている。
プロンプト 3 : アウトドア用品 15〜30 秒滞在の状態アウトドア用品のブースです。
また、ユーザーは 15〜30 秒滞在しています。
ブースでは折りたたみ式チェアコンパクトサイズ、アルミロールテーブル 60cm、防水バックパック 20L、チタン製シェラカップ、ランタン LED ミニランタン防水仕様、広口ボトル 1L、保温保冷ボトル 500ml、ポケットストーブコンパクトサイズ、クッカーセットアルミ製、折りたたみ式レインジャケット軽量設計が販売されています。
プロンプト 4 : オフィス用品 30 秒以上の状態ここはオフィス用品のブースです。
また、ユーザーは 30 秒以上滞在しています。
ブースでは、セロハンテープ 15mm × 35m、ホワイトボードマーカー太字タイプ黒・赤・青・緑4 色セット、付箋 75mm × 75mm 100 枚入り、ルーズリーフ B5 ドット罫 100 枚、マッキー油性ペン細字・極細黒・赤・青 3 色セット、電卓 12 桁大型ディスプレイ、テープのり 8.4mm × 10m、ペーパーカッターミニサイズ、クリアファイル 30 ポケット A4 サイズ、ネーム印スタンプペールブルーが販売されています。